{{ define "pool_defaults" -}}
user = dp_app
group = dp_app
chdir = /srv/deskpro
listen = /run/php_fpm_{{.}}.sock
listen.backlog = {{ getenv "PHP_FPM_LISTEN_BACKLOG" "1000" }}
listen.mode = 0666

pm.status_listen = /run/php_fpm_{{.}}.status.sock
pm.status_path = /fpm/status

clear_env = yes
request_terminate_timeout = 60
request_terminate_timeout_track_finished = yes
security.limit_extensions = ".php"
env[DP_FPM_POOL] = {{.}}
php_value[max_execution_time] = 60
php_value[display_errors] = 0
{{- end -}}

[global]
log_level = {{ getenv "PHP_FPM_LOG_LEVEL" "notice" }}
{{ getenv "PHP_FPM_OVERRIDES" }}

{{/*
   * The dp_internal pool is used when Deskpro is calling itself. For example,
   * a GQL resolver (from dp_agent_* pools) may call a v1/v2 API endpoint.
   *
   * This pool has a very high max_children value here to basically
   * never block internal calls because blocking an internal call could cause
   * bad locking to occur in other pools.
   *
   * When calculating other pool sizes, we must take this into account.
   */}}
[dp_internal]
{{ template "pool_defaults" "dp_internal" }}
pm = ondemand
pm.max_children = 1000
pm.max_requests = 1000
pm.process_idle_timeout = 60s
{{ getenv "PHP_FPM_POOL_OVERRIDES" }}
{{ getenv "PHP_FPM_DP_INTERNAL_OVERRIDES" }}

{{/*
   * The dp_agent_* pools are used for most endpoints called by agent/admin clients
   * such as the GraphQL endpoints.
   */}}
{{range math.Seq (getenv "PHP_FPM_DP_AGENT_NUM_POOLS" "6") }}
[dp_agent_{{.}}]
{{ template "pool_defaults" (print "dp_agent_" .) }}
pm = ondemand
pm.max_children = 5
pm.max_requests = 2000
pm.process_idle_timeout = 60s
php_admin_value[disable_functions] = system, exec, shell_exec, passthru, phpinfo, show_source, highlight_file, popen, proc_open, fopen_with_path, dbase_open, move_uploaded_file, posix_mkfifo
{{ getenv "PHP_FPM_POOL_OVERRIDES" }}
{{ getenv "PHP_FPM_DP_AGENT_OVERRIDES" }}
{{end}}

{{/*
   * The dp_default_* pools are used for everything else that does not have it's own pool.
   * For example, such as the helpcenter and v1/v2 endpoints.
   */}}
{{range math.Seq (getenv "PHP_FPM_DP_DEFAULT_NUM_POOLS" "4")}}
[dp_default_{{.}}]
{{ template "pool_defaults" (print "dp_default_" .) }}
pm = ondemand
pm.max_children = 5
pm.max_requests = 2000
pm.process_idle_timeout = 15s
php_admin_value[disable_functions] = system, exec, shell_exec, passthru, phpinfo, show_source, highlight_file, popen, proc_open, fopen_with_path, dbase_open, move_uploaded_file, posix_mkfifo
{{ getenv "PHP_FPM_POOL_OVERRIDES" }}
{{ getenv "PHP_FPM_DP_DEFAULT_OVERRIDES" }}
{{end}}

{{/*
   * The dp_broadcaster pool is used for the broadcaster service.
   * Every online agent will have an open connection to this pool. It's set to a high
   * value becaue it's effectively the limit of how many agents can use the UI at once.
   * These requests are generally low resource usage but they stay open for ~minute at a time.
   */}}
[dp_broadcaster]
{{ template "pool_defaults" "dp_broadcaster" }}
pm = ondemand
pm.max_children = 2000
pm.max_requests = 250
pm.process_idle_timeout = 30s
request_terminate_timeout = 70
php_admin_value[max_execution_time] = 65
php_admin_value[post_max_size] = 2M
php_admin_flag[file_uploads] = false
php_admin_value[max_input_time] = 10
php_admin_value[disable_functions] = system, exec, shell_exec, passthru, phpinfo, show_source, highlight_file, popen, proc_open, fopen_with_path, dbase_open, move_uploaded_file, posix_mkfifo
{{ getenv "PHP_FPM_POOL_OVERRIDES" }}
{{ getenv "PHP_FPM_DP_BROADCASTER_OVERRIDES" }}


{{if conv.ToBool (getenv "HTTP_INTERNAL_MODE" "false")}}
; SVC_WEB_INTERNAL_MODE=true so we make all pools ondemand
; because they are only relevant when called by a task

[dp_internal]
pm = ondemand
pm.process_idle_timeout = 5s
php_admin_value[opcache.enable]=0

{{range math.Seq (getenv "PHP_FPM_DP_AGENT_NUM_POOLS" "6") }}
[dp_agent_{{.}}]
pm = ondemand
pm.process_idle_timeout = 5s
php_admin_value[opcache.enable]=0
{{end}}

{{range math.Seq (getenv "PHP_FPM_DP_DEFAULT_NUM_POOLS" "4")}}
[dp_default_{{.}}]
pm = ondemand
pm.process_idle_timeout = 5s
php_admin_value[opcache.enable]=0
{{end}}

[dp_broadcaster]
pm = ondemand
pm.process_idle_timeout = 5s
php_admin_value[opcache.enable]=0
{{end}}
