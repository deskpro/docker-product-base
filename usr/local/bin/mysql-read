#!/bin/bash

if [[ -n "$DESKPRO_SITE_INFO" ]]; then
  JSON_CONFIG="$('/srv/deskpro/serve/bin/dump-cfg')"
  export DESKPRO_DB_HOST="$(jq -r '.database.read.host' <<< "$JSON_CONFIG")"
  export DESKPRO_DB_PORT="$(jq -r '.database.read.port' <<< "$JSON_CONFIG")"
  export DESKPRO_DB_USER="$(jq -r '.database.read.user' <<< "$JSON_CONFIG")"
  export DESKPRO_DB_PASS="$(jq -r '.database.read.password' <<< "$JSON_CONFIG")"
  export DESKPRO_DB_NAME="$(jq -r '.database.read.dbname' <<< "$JSON_CONFIG")"
fi

cnf_file_path="$(gomplate -i '{{ path.Join .Env.HOME ".my-auto.cnf" }}')"

eval-tpl --file "/usr/local/share/deskpro/templates/user.my.cnf.tmpl" --out "$cnf_file_path"
exec mysql --defaults-extra-file="$cnf_file_path" --defaults-group-suffix="_read" "$@"
